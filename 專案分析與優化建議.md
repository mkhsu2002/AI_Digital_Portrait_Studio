# AI Digital Portrait Studio - å°ˆæ¡ˆåŠŸèƒ½èˆ‡æ¶æ§‹åˆ†æå ±å‘Š

## ğŸ“‹ å°ˆæ¡ˆåŠŸèƒ½æ¦‚è¿°

ã€Œé›»å•†äººåƒæ”å½±æ£šã€æ˜¯ä¸€å€‹åŸºæ–¼ React + Vite çš„ç¶²é æ‡‰ç”¨ï¼Œæ•´åˆ Google Gemini å½±åƒæ¨¡å‹èˆ‡ Firebase æœå‹™ï¼Œå”åŠ©å“ç‰Œå¿«é€Ÿç”Ÿæˆå¤šè¦–è§’çš„äººåƒå•†å“åœ–ã€‚

### æ ¸å¿ƒåŠŸèƒ½

1. **å¤šè¦–è§’å½±åƒç”Ÿæˆ**
   - ä¸€æ¬¡ç”¢å‡ºå…¨èº«ã€åŠèº«ã€ç‰¹å¯«ä¸‰å¼µåœ–
   - è‡ªå‹•å¥—ç”¨é¸å®šçš„é•·å¯¬æ¯”ï¼ˆ3:4, 4:3, 1:1, 16:9, 9:16ï¼‰
   - ä½¿ç”¨ Google Gemini `gemini-2.5-flash-image` æ¨¡å‹

2. **å¯é¸åƒè€ƒç´ æ**
   - æ”¯æ´ä¸Šå‚³äººç‰©è‡‰å­”åƒè€ƒåœ–ï¼ˆå¼·åŒ–ç”Ÿæˆä¸€è‡´æ€§ï¼‰
   - æ”¯æ´ä¸Šå‚³å•†å“ç‰©ä»¶åƒè€ƒåœ–
   - åœ–ç‰‡è‡ªå‹•å£“ç¸®èˆ‡é©—è­‰

3. **æ­·å²ç´€éŒ„èˆ‡é‚„åŸ**
   - æ¯ä½ç™»å…¥ä½¿ç”¨è€…å¯ä¿ç•™æœ€è¿‘ 5 ç­†ç”Ÿæˆç´€éŒ„
   - ä¸€éµè¼‰å…¥è¨­å®šï¼ˆé‚„åŸè¡¨å–®åƒæ•¸ï¼‰
   - åœ–ç‰‡å„²å­˜æ–¼ Firebase Storageï¼Œæ­·å²è³‡æ–™å„²å­˜æ–¼ Firestore

4. **å‹•æ…‹å½±åƒå»¶ä¼¸**
   - å¯å°‡ä»»ä¸€å¼µåœ–è½‰äº¤ Gemini Veo (`veo-3.1-fast-generate-preview`) ç”¢ç”Ÿ 720p å‹•æ…‹å½±åƒ
   - åƒ…æ”¯æ´ 16:9 æˆ– 9:16 é•·å¯¬æ¯”
   - ä½¿ç”¨è¼ªè©¢æ©Ÿåˆ¶è¿½è¹¤ç”Ÿæˆé€²åº¦

5. **å®Œå–„å¸³è™Ÿé«”é©—**
   - Firebase Authentication æä¾›è¨»å†Šã€ç™»å…¥ã€å¿˜è¨˜å¯†ç¢¼æµç¨‹
   - é¡¯ç¤ºå‰©é¤˜ç”Ÿæˆæ¬¡æ•¸ï¼ˆé è¨­æ¯ä½æ–°ä½¿ç”¨è€… 100 æ¬¡ï¼‰
   - ä½¿ç”¨æ¬¡æ•¸ç®¡ç†èˆ‡æ‰£æ¸›æ©Ÿåˆ¶

6. **å¤šèªè¨€æ”¯æ´**
   - ç¹é«”ä¸­æ–‡èˆ‡è‹±æ–‡åˆ‡æ›
   - å®Œæ•´çš„ UI æ–‡å­—ç¿»è­¯
   - é¸é …æ¨™ç±¤è‡ªå‹•ç¿»è­¯

7. **è±å¯Œçš„å®¢è£½åŒ–é¸é …**
   - 11 ç¨®æœè£é¢¨æ ¼
   - 8 ç¨®å­£ç¯€/æ°£å€™é¸é …
   - 23 ç¨®èƒŒæ™¯ç’°å¢ƒ
   - 7 ç¨®è¡¨æƒ…
   - 15 ç¨®äººç‰©å§¿å‹¢
   - 12 ç¨®å…‰ç·šæ¢ä»¶
   - 2 ç¨®æ¨¡ç‰¹å…’æ€§åˆ¥

---

## ğŸ—ï¸ ç¨‹å¼æ¶æ§‹åˆ†æ

### æŠ€è¡“æ£§

| é¡åˆ¥ | æŠ€è¡“ | ç‰ˆæœ¬ |
|------|------|------|
| å‰ç«¯æ¡†æ¶ | React | 19.2.0 |
| é–‹ç™¼èªè¨€ | TypeScript | 5.8.2 |
| å»ºç½®å·¥å…· | Vite | 6.2.0 |
| UI æ¡†æ¶ | Tailwind CSS | 3.4.15 |
| å¾Œç«¯æœå‹™ | Firebase | 12.5.0 |
| AI æœå‹™ | Google Gemini API | latest |
| ç‹€æ…‹ç®¡ç† | React Context API | - |
| ç¨‹å¼ç¢¼å“è³ª | ESLint, Prettier | - |

### ç›®éŒ„çµæ§‹

```
AI_Digital_Portrait_Studio/
â”œâ”€â”€ components/              # UI çµ„ä»¶
â”‚   â”œâ”€â”€ AuthGate.tsx        # èªè­‰é–˜é“ï¼ˆç™»å…¥/è¨»å†Šè¡¨å–®ï¼‰
â”‚   â”œâ”€â”€ ErrorBoundary.tsx   # éŒ¯èª¤é‚Šç•Œçµ„ä»¶
â”‚   â”œâ”€â”€ Header.tsx          # é é¦–ï¼ˆé¡¯ç¤ºä½¿ç”¨è€…è³‡è¨Šã€å‰©é¤˜æ¬¡æ•¸ï¼‰
â”‚   â”œâ”€â”€ HistoryPanel.tsx    # æ­·å²ç´€éŒ„é¢æ¿
â”‚   â”œâ”€â”€ InputGroup.tsx      # è¡¨å–®è¼¸å…¥çµ„ä»¶
â”‚   â”œâ”€â”€ LoadingProgress.tsx # è¼‰å…¥é€²åº¦æŒ‡ç¤ºå™¨
â”‚   â”œâ”€â”€ PromptDisplay.tsx   # çµæœé¡¯ç¤ºå€åŸŸï¼ˆåœ–ç‰‡ã€å½±ç‰‡ï¼‰
â”‚   â”œâ”€â”€ PromptForm.tsx     # ä¸»è¦è¡¨å–®çµ„ä»¶
â”‚   â””â”€â”€ icons/              # SVG åœ–ç¤ºçµ„ä»¶
â”‚       â”œâ”€â”€ CheckIcon.tsx
â”‚       â”œâ”€â”€ ClipboardIcon.tsx
â”‚       â”œâ”€â”€ DownloadIcon.tsx
â”‚       â”œâ”€â”€ HistoryIcon.tsx
â”‚       â”œâ”€â”€ RemoveIcon.tsx
â”‚       â””â”€â”€ SpinnerIcon.tsx
â”œâ”€â”€ contexts/               # Context æä¾›è€…
â”‚   â”œâ”€â”€ ApiContext.tsx       # API å‘¼å«å°è£ï¼ˆGeminiã€Veoã€Firebaseï¼‰
â”‚   â”œâ”€â”€ AuthContext.tsx      # èªè­‰ç‹€æ…‹ç®¡ç†
â”‚   â””â”€â”€ TranslationContext.tsx # å¤šèªè¨€ç®¡ç†
â”œâ”€â”€ hooks/                  # è‡ªè¨‚ Hooks
â”‚   â””â”€â”€ useDebounce.ts      # é˜²æŠ–å‹• Hook
â”œâ”€â”€ services/               # æ¥­å‹™é‚è¼¯æœå‹™å±¤
â”‚   â”œâ”€â”€ historyService.ts   # æ­·å²ç´€éŒ„ CRUD æ“ä½œ
â”‚   â””â”€â”€ usageService.ts     # ä½¿ç”¨æ¬¡æ•¸ç®¡ç†
â”œâ”€â”€ types/                  # TypeScript å‹åˆ¥å®šç¾©
â”‚   â”œâ”€â”€ api.ts              # API å›æ‡‰å‹åˆ¥
â”‚   â””â”€â”€ types.ts            # é€šç”¨å‹åˆ¥å®šç¾©
â”œâ”€â”€ utils/                  # å·¥å…·å‡½æ•¸
â”‚   â”œâ”€â”€ envValidation.ts    # ç’°å¢ƒè®Šæ•¸é©—è­‰
â”‚   â”œâ”€â”€ imageCompression.ts # åœ–ç‰‡å£“ç¸®å·¥å…·
â”‚   â”œâ”€â”€ imageUtils.ts       # åœ–ç‰‡è™•ç†å·¥å…·
â”‚   â”œâ”€â”€ promptBuilder.ts   # Prompt ç”Ÿæˆé‚è¼¯
â”‚   â”œâ”€â”€ retry.ts            # é‡è©¦æ©Ÿåˆ¶ï¼ˆexponential backoffï¼‰
â”‚   â””â”€â”€ validation.ts       # è¡¨å–®é©—è­‰
â”œâ”€â”€ styles/                 # æ¨£å¼æª”æ¡ˆ
â”‚   â””â”€â”€ tailwind.css        # Tailwind CSS å…¥å£
â”œâ”€â”€ public/                 # éœæ…‹è³‡æº
â”‚   â”œâ”€â”€ _headers            # Cloudflare Pages headers
â”‚   â””â”€â”€ _redirects          # è·¯ç”±é‡å®šå‘è¨­å®š
â”œâ”€â”€ App.tsx                 # ä¸»æ‡‰ç”¨ç¨‹å¼çµ„ä»¶
â”œâ”€â”€ index.tsx               # æ‡‰ç”¨ç¨‹å¼å…¥å£
â”œâ”€â”€ firebase.ts             # Firebase åˆå§‹åŒ–
â”œâ”€â”€ constants.ts            # å¸¸æ•¸å®šç¾©ï¼ˆé¸é …åˆ—è¡¨ï¼‰
â”œâ”€â”€ vite.config.ts          # Vite è¨­å®š
â”œâ”€â”€ tsconfig.json           # TypeScript è¨­å®š
â””â”€â”€ package.json            # å°ˆæ¡ˆä¾è³´èˆ‡è…³æœ¬
```

### è³‡æ–™æµæ¶æ§‹

#### 1. ä½¿ç”¨è€…èªè­‰æµç¨‹
```
AuthGate â†’ AuthContext â†’ Firebase Auth â†’ App.tsx (user state)
```

#### 2. åœ–ç‰‡ç”Ÿæˆæµç¨‹
```
PromptForm (è¡¨å–®è¼¸å…¥)
  â†“
App.tsx (formData state)
  â†“
ApiContext.generateImages()
  â†“
Gemini API (3 å€‹ä¸¦è¡Œè«‹æ±‚ï¼šå…¨èº«ã€åŠèº«ã€ç‰¹å¯«)
  â†“
åœ–ç‰‡è™•ç†èˆ‡è½‰æ›
  â†“
Firebase Storage (ä¸Šå‚³åœ–ç‰‡)
  â†“
Firestore (å„²å­˜æ­·å²ç´€éŒ„)
  â†“
PromptDisplay (é¡¯ç¤ºçµæœ)
```

#### 3. å½±ç‰‡ç”Ÿæˆæµç¨‹
```
PromptDisplay (é»æ“Šç”Ÿæˆå½±ç‰‡)
  â†“
App.tsx.handleGenerateVideo()
  â†“
ApiContext.generateVideo()
  â†“
Veo API (å•Ÿå‹•ç”Ÿæˆä½œæ¥­)
  â†“
è¼ªè©¢ä½œæ¥­ç‹€æ…‹ (æ¯ 5 ç§’)
  â†“
ä¸‹è¼‰å½±ç‰‡
  â†“
é¡¯ç¤ºå½±ç‰‡
```

#### 4. æ­·å²ç´€éŒ„æµç¨‹
```
App.tsx (è¼‰å…¥æ™‚)
  â†“
ApiContext.loadUserHistory()
  â†“
historyService.fetchUserHistory()
  â†“
Firestore (æŸ¥è©¢æœ€è¿‘ 5 ç­†)
  â†“
HistoryPanel (é¡¯ç¤ºåˆ—è¡¨)
```

### ç‹€æ…‹ç®¡ç†æ¶æ§‹

å°ˆæ¡ˆä½¿ç”¨ React Context API é€²è¡Œç‹€æ…‹ç®¡ç†ï¼Œåˆ†ç‚ºä¸‰å€‹ä¸»è¦ Contextï¼š

1. **AuthContext**ï¼šç®¡ç†ä½¿ç”¨è€…èªè­‰ç‹€æ…‹
   - `user`: Firebase User ç‰©ä»¶
   - `initializing`: åˆå§‹åŒ–ç‹€æ…‹
   - `login`, `register`, `logout`, `resetPassword`: èªè­‰æ–¹æ³•

2. **TranslationContext**ï¼šç®¡ç†å¤šèªè¨€ç‹€æ…‹
   - `language`: ç•¶å‰èªè¨€ï¼ˆ'zh' | 'en'ï¼‰
   - `t`: ç¿»è­¯ç‰©ä»¶
   - `translateOption`: é¸é …ç¿»è­¯å‡½æ•¸
   - `translateShotLabel`: è¦–è§’æ¨™ç±¤ç¿»è­¯å‡½æ•¸

3. **ApiContext**ï¼šå°è£æ‰€æœ‰ API å‘¼å«
   - `generateImages`: ç”Ÿæˆåœ–ç‰‡
   - `generateVideo`: ç”Ÿæˆå½±ç‰‡
   - `uploadHistoryImages`: ä¸Šå‚³æ­·å²åœ–ç‰‡
   - `loadUserHistory`: è¼‰å…¥æ­·å²ç´€éŒ„
   - `saveHistoryRecord`: å„²å­˜æ­·å²ç´€éŒ„
   - `deleteHistoryRecord`: åˆªé™¤æ­·å²ç´€éŒ„
   - `loadGenerationQuota`: è¼‰å…¥ä½¿ç”¨æ¬¡æ•¸
   - `consumeCredit`: æ‰£æ¸›ä½¿ç”¨æ¬¡æ•¸

### é—œéµè¨­è¨ˆæ¨¡å¼

1. **Context Provider æ¨¡å¼**ï¼šå°‡æ¥­å‹™é‚è¼¯å°è£åœ¨ Context ä¸­
2. **Service Layer æ¨¡å¼**ï¼šå°‡ Firebase æ“ä½œæŠ½é›¢ç‚ºæœå‹™å±¤
3. **Utility Functions**ï¼šå·¥å…·å‡½æ•¸æ¨¡çµ„åŒ–
4. **Lazy Loading**ï¼šä½¿ç”¨ React.lazy é€²è¡Œç¨‹å¼ç¢¼åˆ†å‰²
5. **Error Boundary**ï¼šéŒ¯èª¤é‚Šç•Œè™•ç†
6. **Retry Pattern**ï¼šAPI å‘¼å«é‡è©¦æ©Ÿåˆ¶ï¼ˆexponential backoffï¼‰

---

## ğŸ¯ å„ªåŒ–æ”¹å–„å»ºè­°

### ğŸ”´ é«˜å„ªå…ˆç´šï¼ˆå½±éŸ¿åŠŸèƒ½èˆ‡ç©©å®šæ€§ï¼‰

#### 1. **ç¨‹å¼ç¢¼çµ„ç¹”èˆ‡æ¨¡çµ„åŒ–**

**ç¾æ³å•é¡Œ**ï¼š
- `App.tsx` æª”æ¡ˆéå¤§ï¼ˆ435 è¡Œï¼‰ï¼ŒåŒ…å«éå¤šæ¥­å‹™é‚è¼¯
- `ApiContext.tsx` æª”æ¡ˆéå¤§ï¼ˆ508 è¡Œï¼‰ï¼Œè·è²¬éå¤š
- åœ–ç‰‡ç”Ÿæˆé‚è¼¯èˆ‡ UI é‚è¼¯è€¦åˆ

**å»ºè­°æ”¹å–„**ï¼š
- âœ… å°‡åœ–ç‰‡ç”Ÿæˆé‚è¼¯æŠ½é›¢ç‚º `hooks/useImageGeneration.ts`
- âœ… å°‡å½±ç‰‡ç”Ÿæˆé‚è¼¯æŠ½é›¢ç‚º `hooks/useVideoGeneration.ts`
- âœ… å°‡æ­·å²ç´€éŒ„ç®¡ç†æŠ½é›¢ç‚º `hooks/useHistory.ts`
- âœ… å°‡è¡¨å–®ç‹€æ…‹ç®¡ç†æŠ½é›¢ç‚º `hooks/useFormData.ts`
- âœ… å°‡ `ApiContext` æ‹†åˆ†ç‚ºå¤šå€‹å°ˆæ³¨çš„ Contextï¼ˆå¦‚ `GeminiContext`, `FirebaseContext`ï¼‰

**é æœŸæ•ˆç›Š**ï¼š
- æå‡ç¨‹å¼ç¢¼å¯è®€æ€§èˆ‡å¯ç¶­è­·æ€§
- é™ä½çµ„ä»¶è¤‡é›œåº¦
- æé«˜ç¨‹å¼ç¢¼å¯æ¸¬è©¦æ€§

---

#### 2. **éŒ¯èª¤è™•ç†èˆ‡ä½¿ç”¨è€…é«”é©—**

**ç¾æ³å•é¡Œ**ï¼š
- éŒ¯èª¤è¨Šæ¯ä¸å¤ å‹å–„ï¼ˆéƒ¨åˆ†éŒ¯èª¤ç›´æ¥é¡¯ç¤ºæŠ€è¡“è¨Šæ¯ï¼‰
- ç¶²è·¯éŒ¯èª¤æ™‚ç¼ºä¹æ˜ç¢ºçš„é‡è©¦æç¤º
- åœ–ç‰‡ä¸Šå‚³å¤±æ•—æ™‚æ²’æœ‰æ˜ç¢ºçš„éŒ¯èª¤è™•ç†
- API éŒ¯èª¤ç¼ºä¹åˆ†é¡èˆ‡è™•ç†ç­–ç•¥

**å»ºè­°æ”¹å–„**ï¼š
- âœ… å»ºç«‹çµ±ä¸€çš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶ï¼ˆ`utils/errorHandler.ts`ï¼‰
- âœ… å¯¦ä½œéŒ¯èª¤åˆ†é¡ï¼ˆç¶²è·¯éŒ¯èª¤ã€API éŒ¯èª¤ã€é©—è­‰éŒ¯èª¤ç­‰ï¼‰
- âœ… ç‚ºä½¿ç”¨è€…æä¾›å‹å–„çš„éŒ¯èª¤è¨Šæ¯
- âœ… åŠ å…¥éŒ¯èª¤é‡è©¦ UIï¼ˆé¡¯ç¤ºé‡è©¦æŒ‰éˆ•ï¼‰
- âœ… æ”¹å–„ Loading ç‹€æ…‹çš„è¦–è¦ºå›é¥‹ï¼ˆé€²åº¦æ¢ã€ç™¾åˆ†æ¯”ï¼‰

**é æœŸæ•ˆç›Š**ï¼š
- æå‡ä½¿ç”¨è€…é«”é©—
- é™ä½ä½¿ç”¨è€…å›°æƒ‘
- æé«˜éŒ¯èª¤æ¢å¾©èƒ½åŠ›

---

#### 3. **å‹åˆ¥å®‰å…¨èˆ‡å‹åˆ¥å®šç¾©**

**ç¾æ³å•é¡Œ**ï¼š
- `ApiContext.tsx` ä¸­æœ‰éƒ¨åˆ†å‹åˆ¥æ¨æ–·ä¸å¤ æ˜ç¢º
- API å›æ‡‰çµæ§‹çš„å‹åˆ¥å®šç¾©å¯ä»¥æ›´å®Œæ•´
- éƒ¨åˆ†å‡½æ•¸åƒæ•¸ä½¿ç”¨ `any` æˆ–éæ–¼å¯¬é¬†çš„å‹åˆ¥

**å»ºè­°æ”¹å–„**ï¼š
- âœ… å®Œå–„ `types/api.ts` ä¸­çš„å‹åˆ¥å®šç¾©
- âœ… ç§»é™¤æ‰€æœ‰ `any` å‹åˆ¥ï¼Œæ”¹ç”¨å…·é«”å‹åˆ¥æˆ– `unknown` + å‹åˆ¥å®ˆè¡›
- âœ… ä½¿ç”¨ Zod æˆ– Yup é€²è¡ŒåŸ·è¡Œæ™‚å‹åˆ¥é©—è­‰
- âœ… ç‚º API å›æ‡‰å»ºç«‹å®Œæ•´çš„å‹åˆ¥å®šç¾©

**é æœŸæ•ˆç›Š**ï¼š
- æå‡å‹åˆ¥å®‰å…¨æ€§
- æ¸›å°‘åŸ·è¡Œæ™‚éŒ¯èª¤
- æ”¹å–„é–‹ç™¼é«”é©—ï¼ˆIDE è‡ªå‹•å®Œæˆï¼‰

---

#### 4. **æ•ˆèƒ½å„ªåŒ–**

**ç¾æ³å•é¡Œ**ï¼š
- åœ–ç‰‡ä»¥ base64 æ ¼å¼å„²å­˜åœ¨è¨˜æ†¶é«”ä¸­ï¼Œå¯èƒ½é€ æˆè¨˜æ†¶é«”å•é¡Œ
- æ­·å²ç´€éŒ„è¼‰å…¥æ™‚æ²’æœ‰åˆ†é æˆ–è™›æ“¬æ»¾å‹•
- è¡¨å–®è®Šæ›´æ™‚é »ç¹é‡æ–°è¨ˆç®— promptï¼ˆå·²ä½¿ç”¨ debounceï¼Œä½†å¯é€²ä¸€æ­¥å„ªåŒ–ï¼‰
- åœ–ç‰‡ç”Ÿæˆæ™‚æ²’æœ‰é€²åº¦å›é¥‹

**å»ºè­°æ”¹å–„**ï¼š
- âœ… åœ–ç‰‡è™•ç†æ”¹ç‚ºä½¿ç”¨ Blob URL è€Œé base64ï¼ˆæ¸›å°‘è¨˜æ†¶é«”ä½¿ç”¨ï¼‰
- âœ… æ­·å²ç´€éŒ„å¯¦ä½œè™›æ“¬æ»¾å‹•ï¼ˆreact-windowï¼‰æˆ–åˆ†é è¼‰å…¥
- âœ… ä½¿ç”¨ React.memo å„ªåŒ–å­çµ„ä»¶æ¸²æŸ“ï¼ˆPromptFormã€HistoryPanelï¼‰
- âœ… åŠ å…¥åœ–ç‰‡ç”Ÿæˆé€²åº¦æŒ‡ç¤ºå™¨ï¼ˆå¦‚æœ API æ”¯æ´ï¼‰
- âœ… å¯¦ä½œåœ–ç‰‡æ‡¶è¼‰å…¥ï¼ˆlazy loadingï¼‰

**é æœŸæ•ˆç›Š**ï¼š
- é™ä½è¨˜æ†¶é«”ä½¿ç”¨
- æå‡é é¢è¼‰å…¥é€Ÿåº¦
- æ”¹å–„ä½¿ç”¨è€…é«”é©—

---

### ğŸŸ¡ ä¸­å„ªå…ˆç´šï¼ˆæ”¹å–„ç¨‹å¼å“è³ªèˆ‡å¯ç¶­è­·æ€§ï¼‰

#### 5. **API å‘¼å«å„ªåŒ–**

**ç¾æ³å•é¡Œ**ï¼š
- API Key ç›´æ¥æš´éœ²åœ¨å‰ç«¯ç¨‹å¼ç¢¼ä¸­ï¼ˆé›–ç„¶æœ‰æ“´å……åŠŸèƒ½æ”¯æ´ï¼Œä½†ä»æœ‰å®‰å…¨é¢¨éšªï¼‰
- æ²’æœ‰çµ±ä¸€çš„ API å®¢æˆ¶ç«¯å°è£
- ç¼ºä¹è«‹æ±‚å–æ¶ˆæ©Ÿåˆ¶ï¼ˆä½¿ç”¨è€…é›¢é–‹é é¢æ™‚ï¼‰
- æ²’æœ‰è«‹æ±‚å»é‡ï¼ˆdeduplicationï¼‰æ©Ÿåˆ¶

**å»ºè­°æ”¹å–„**ï¼š
- âœ… å»ºç«‹ `services/apiClient.ts` çµ±ä¸€ç®¡ç† API å‘¼å«
- âœ… å¯¦ä½œè«‹æ±‚å–æ¶ˆæ©Ÿåˆ¶ï¼ˆAbortControllerï¼‰
- âœ… åŠ å…¥è«‹æ±‚å»é‡æ©Ÿåˆ¶ï¼ˆé¿å…é‡è¤‡è«‹æ±‚ï¼‰
- âœ… è€ƒæ…®å°‡æ•æ„Ÿ API å‘¼å«ç§»è‡³å¾Œç«¯ï¼ˆFirebase Cloud Functionsï¼‰
- âœ… å¯¦ä½œ API å‘¼å«å¿«å–æ©Ÿåˆ¶ï¼ˆå°æ–¼ç›¸åŒåƒæ•¸çš„è«‹æ±‚ï¼‰

**é æœŸæ•ˆç›Š**ï¼š
- æå‡å®‰å…¨æ€§
- æ¸›å°‘ä¸å¿…è¦çš„ API å‘¼å«
- æ”¹å–„éŒ¯èª¤è™•ç†

---

#### 6. **ç‹€æ…‹ç®¡ç†å„ªåŒ–**

**ç¾æ³å•é¡Œ**ï¼š
- å¤šå€‹ç›¸é—œç‹€æ…‹åˆ†æ•£ç®¡ç†ï¼ˆimages, isLoading, errorï¼‰
- æ­·å²ç´€éŒ„èˆ‡è¡¨å–®ç‹€æ…‹è€¦åˆåº¦é«˜
- ç‹€æ…‹æ›´æ–°é‚è¼¯åˆ†æ•£åœ¨å¤šè™•

**å»ºè­°æ”¹å–„**ï¼š
- âœ… ä½¿ç”¨ `useReducer` ç®¡ç†è¤‡é›œç‹€æ…‹ï¼ˆå¦‚ç”Ÿæˆæµç¨‹ç‹€æ…‹æ©Ÿï¼‰
- âœ… è€ƒæ…®å¼•å…¥ Zustand æˆ– Jotai é€²è¡Œè¼•é‡ç´šç‹€æ…‹ç®¡ç†ï¼ˆå¦‚æœéœ€è¦ï¼‰
- âœ… å°‡æ­·å²ç´€éŒ„ç‹€æ…‹æŠ½é›¢ç‚ºç¨ç«‹ Hook
- âœ… å¯¦ä½œç‹€æ…‹æŒä¹…åŒ–ï¼ˆlocalStorageï¼‰

**é æœŸæ•ˆç›Š**ï¼š
- æå‡ç‹€æ…‹ç®¡ç†æ¸…æ™°åº¦
- é™ä½ç‹€æ…‹æ›´æ–°éŒ¯èª¤
- æ”¹å–„ç¨‹å¼ç¢¼å¯ç¶­è­·æ€§

---

#### 7. **æ¸¬è©¦è¦†è“‹**

**ç¾æ³å•é¡Œ**ï¼š
- å°ˆæ¡ˆä¸­æ²’æœ‰æ¸¬è©¦æª”æ¡ˆ
- ç¼ºä¹å–®å…ƒæ¸¬è©¦èˆ‡æ•´åˆæ¸¬è©¦
- é—œéµæ¥­å‹™é‚è¼¯ç¼ºä¹æ¸¬è©¦ä¿è­·

**å»ºè­°æ”¹å–„**ï¼š
- âœ… ä½¿ç”¨ Vitest é€²è¡Œå–®å…ƒæ¸¬è©¦
- âœ… ä½¿ç”¨ React Testing Library æ¸¬è©¦çµ„ä»¶
- âœ… ç‚ºé—œéµæ¥­å‹™é‚è¼¯ï¼ˆå¦‚ `usageService`, `historyService`ï¼‰æ’°å¯«æ¸¬è©¦
- âœ… ç‚ºå·¥å…·å‡½æ•¸ï¼ˆå¦‚ `promptBuilder`, `imageCompression`ï¼‰æ’°å¯«æ¸¬è©¦
- âœ… åŠ å…¥ E2E æ¸¬è©¦ï¼ˆä½¿ç”¨ Playwright æˆ– Cypressï¼‰

**é æœŸæ•ˆç›Š**ï¼š
- æå‡ç¨‹å¼ç¢¼å“è³ª
- é™ä½å›æ­¸éŒ¯èª¤é¢¨éšª
- æ”¹å–„é‡æ§‹ä¿¡å¿ƒ

---

#### 8. **å®‰å…¨æ€§å¼·åŒ–**

**ç¾æ³å•é¡Œ**ï¼š
- API Key æš´éœ²åœ¨å‰ç«¯ï¼ˆé›–ç„¶æœ‰æ“´å……åŠŸèƒ½æ”¯æ´ï¼‰
- æª”æ¡ˆä¸Šå‚³é©—è­‰ä¸å¤ åš´æ ¼
- æ²’æœ‰è¼¸å…¥æ¸…ç†æ©Ÿåˆ¶ï¼ˆXSS é˜²è­·ï¼‰

**å»ºè­°æ”¹å–„**ï¼š
- âœ… å¯¦ä½œæª”æ¡ˆå¤§å°é™åˆ¶ï¼ˆå‰ç«¯èˆ‡å¾Œç«¯ï¼‰
- âœ… åŠ å…¥æª”æ¡ˆé¡å‹é©—è­‰ï¼ˆMIME type æª¢æŸ¥ï¼‰
- âœ… ä½¿ç”¨ Firebase Security Rules ä¿è­· Firestore èˆ‡ Storage
- âœ… è€ƒæ…®ä½¿ç”¨ Cloud Functions ä½œç‚º API ä»£ç†å±¤
- âœ… åŠ å…¥è¼¸å…¥æ¸…ç†æ©Ÿåˆ¶ï¼ˆé˜²æ­¢ XSSï¼‰
- âœ… å¯¦ä½œ CSRF é˜²è­·ï¼ˆå¦‚æœä½¿ç”¨å¾Œç«¯ APIï¼‰

**é æœŸæ•ˆç›Š**ï¼š
- æå‡æ‡‰ç”¨ç¨‹å¼å®‰å…¨æ€§
- é˜²æ­¢æƒ¡æ„æª”æ¡ˆä¸Šå‚³
- ä¿è­·ä½¿ç”¨è€…è³‡æ–™

---

### ğŸŸ¢ ä½å„ªå…ˆç´šï¼ˆåŠŸèƒ½å¢å¼·èˆ‡ä½¿ç”¨è€…é«”é©—ï¼‰

#### 9. **ä½¿ç”¨è€…é«”é©—æ”¹å–„**

**ç¾æ³å•é¡Œ**ï¼š
- åœ–ç‰‡ç”Ÿæˆæ™‚æ²’æœ‰é€²åº¦å›é¥‹
- ç„¡æ³•é è¦½ä¸Šå‚³çš„åƒè€ƒåœ–ç‰‡ï¼ˆå·²æœ‰é è¦½åŠŸèƒ½ï¼Œä½†å¯æ”¹å–„ï¼‰
- æ­·å²ç´€éŒ„åˆªé™¤åŠŸèƒ½å·²æœ‰ï¼Œä½†å¯æ”¹å–„ UX
- ç¼ºä¹éµç›¤å¿«æ·éµæ”¯æ´

**å»ºè­°æ”¹å–„**ï¼š
- âœ… åŠ å…¥åœ–ç‰‡ç”Ÿæˆé€²åº¦æ¢ï¼ˆå¦‚æœ API æ”¯æ´ï¼‰
- âœ… æ”¹å–„åƒè€ƒåœ–ç‰‡é è¦½ï¼ˆæ”¾å¤§ã€æ—‹è½‰ç­‰åŠŸèƒ½ï¼‰
- âœ… åŠ å…¥éµç›¤å¿«æ·éµæ”¯æ´ï¼ˆCtrl+Enter ç”Ÿæˆã€Esc å–æ¶ˆç­‰ï¼‰
- âœ… æ”¹å–„éŸ¿æ‡‰å¼è¨­è¨ˆï¼ˆè¡Œå‹•è£ç½®é«”é©—ï¼‰
- âœ… åŠ å…¥æ‹–æ”¾ä¸Šå‚³åŠŸèƒ½
- âœ… å¯¦ä½œæ‰¹é‡æ“ä½œï¼ˆæ‰¹é‡åˆªé™¤æ­·å²ç´€éŒ„ï¼‰

**é æœŸæ•ˆç›Š**ï¼š
- æå‡ä½¿ç”¨è€…é«”é©—
- æé«˜æ“ä½œæ•ˆç‡
- æ”¹å–„è¡Œå‹•è£ç½®é«”é©—

---

#### 10. **åœ‹éš›åŒ–æ”¹å–„**

**ç¾æ³å•é¡Œ**ï¼š
- ç¿»è­¯å…§å®¹ç¡¬ç·¨ç¢¼åœ¨ `TranslationContext.tsx` ä¸­
- ç„¡æ³•å‹•æ…‹è¼‰å…¥èªè¨€åŒ…
- åƒ…æ”¯æ´ç¹é«”ä¸­æ–‡èˆ‡è‹±æ–‡

**å»ºè­°æ”¹å–„**ï¼š
- âœ… å°‡ç¿»è­¯å…§å®¹æŠ½é›¢ç‚º JSON æª”æ¡ˆï¼ˆ`locales/zh.json`, `locales/en.json`ï¼‰
- âœ… ä½¿ç”¨ i18next æˆ– react-intl é€²è¡Œåœ‹éš›åŒ–ç®¡ç†
- âœ… æ”¯æ´æ›´å¤šèªè¨€ï¼ˆæ—¥æ–‡ã€éŸ“æ–‡ç­‰ï¼‰
- âœ… å¯¦ä½œèªè¨€åŒ…å‹•æ…‹è¼‰å…¥

**é æœŸæ•ˆç›Š**ï¼š
- æå‡åœ‹éš›åŒ–æ”¯æ´
- é™ä½ç¿»è­¯ç¶­è­·æˆæœ¬
- æ”¹å–„æ“´å±•æ€§

---

#### 11. **æ•ˆèƒ½ç›£æ§èˆ‡åˆ†æ**

**ç¾æ³å•é¡Œ**ï¼š
- ç¼ºä¹æ•ˆèƒ½ç›£æ§æ©Ÿåˆ¶
- ç„¡æ³•è¿½è¹¤ä½¿ç”¨è€…è¡Œç‚º
- æ²’æœ‰éŒ¯èª¤è¿½è¹¤ç³»çµ±

**å»ºè­°æ”¹å–„**ï¼š
- âœ… æ•´åˆ Google Analytics æˆ– Firebase Analytics
- âœ… åŠ å…¥æ•ˆèƒ½æŒ‡æ¨™è¿½è¹¤ï¼ˆLCP, FID, CLSï¼‰
- âœ… è¨˜éŒ„ API å‘¼å«æ™‚é–“èˆ‡éŒ¯èª¤ç‡
- âœ… åŠ å…¥ Sentry é€²è¡ŒéŒ¯èª¤è¿½è¹¤
- âœ… å¯¦ä½œä½¿ç”¨è€…è¡Œç‚ºåˆ†æï¼ˆç†±é»åœ–ã€ä½¿ç”¨è€…æµç¨‹ï¼‰

**é æœŸæ•ˆç›Š**ï¼š
- æå‡å•é¡Œè¨ºæ–·èƒ½åŠ›
- æ”¹å–„ä½¿ç”¨è€…é«”é©—
- æ”¯æ´æ•¸æ“šé©…å‹•æ±ºç­–

---

#### 12. **ç¨‹å¼ç¢¼å“è³ªå·¥å…·**

**ç¾æ³å•é¡Œ**ï¼š
- å·²æœ‰ ESLint å’Œ Prettier è¨­å®šï¼Œä½†å¯é€²ä¸€æ­¥å„ªåŒ–
- ç¼ºä¹ pre-commit hooks
- CI/CD æµç¨‹å¯ä»¥æ›´å®Œå–„

**å»ºè­°æ”¹å–„**ï¼š
- âœ… å„ªåŒ– ESLint è¦å‰‡ï¼ˆåŠ å…¥æ›´å¤šè¦å‰‡ï¼‰
- âœ… åŠ å…¥ pre-commit hooksï¼ˆä½¿ç”¨ husky + lint-stagedï¼‰
- âœ… è¨­å®š CI/CD æµç¨‹ï¼ˆè‡ªå‹•æ¸¬è©¦ã€å»ºç½®ã€éƒ¨ç½²ï¼‰
- âœ… åŠ å…¥ç¨‹å¼ç¢¼è¦†è“‹ç‡å ±å‘Š
- âœ… å¯¦ä½œè‡ªå‹•åŒ–ç¨‹å¼ç¢¼å¯©æŸ¥ï¼ˆCodeQLï¼‰

**é æœŸæ•ˆç›Š**ï¼š
- æå‡ç¨‹å¼ç¢¼å“è³ª
- é™ä½äººç‚ºéŒ¯èª¤
- æ”¹å–„é–‹ç™¼æµç¨‹

---

## ğŸ“Š å„ªå…ˆç´šç¸½çµ

### ç«‹å³è™•ç†ï¼ˆæœ¬é€±ï¼‰
1. âœ… **ç¨‹å¼ç¢¼çµ„ç¹”èˆ‡æ¨¡çµ„åŒ–**ï¼šæ‹†åˆ† `App.tsx` å’Œ `ApiContext.tsx`
2. âœ… **éŒ¯èª¤è™•ç†æ”¹å–„**ï¼šå»ºç«‹çµ±ä¸€éŒ¯èª¤è™•ç†æ©Ÿåˆ¶
3. âœ… **å‹åˆ¥å®‰å…¨**ï¼šå®Œå–„å‹åˆ¥å®šç¾©ï¼Œç§»é™¤ `any`

### çŸ­æœŸæ”¹å–„ï¼ˆæœ¬æœˆï¼‰
4. âœ… **æ•ˆèƒ½å„ªåŒ–**ï¼šåœ–ç‰‡è™•ç†å„ªåŒ–ã€è™›æ“¬æ»¾å‹•
5. âœ… **API å‘¼å«å„ªåŒ–**ï¼šçµ±ä¸€ API å®¢æˆ¶ç«¯ã€è«‹æ±‚å–æ¶ˆ
6. âœ… **æ¸¬è©¦è¦†è“‹**ï¼šåŠ å…¥åŸºæœ¬å–®å…ƒæ¸¬è©¦

### é•·æœŸå„ªåŒ–ï¼ˆä¸‹å­£åº¦ï¼‰
7. âœ… **å®‰å…¨æ€§å¼·åŒ–**ï¼šå¾Œç«¯ API ä»£ç†ã€å®‰å…¨è¦å‰‡
8. âœ… **æ•ˆèƒ½ç›£æ§**ï¼šæ•´åˆåˆ†æå·¥å…·
9. âœ… **åœ‹éš›åŒ–æ”¹å–„**ï¼šä½¿ç”¨ i18nextã€æ”¯æ´æ›´å¤šèªè¨€

---

## ğŸ”§ å…·é«”å¯¦ä½œå»ºè­°

### ç¯„ä¾‹ 1ï¼šæ‹†åˆ† `useImageGeneration` Hook

```typescript
// hooks/useImageGeneration.ts
import { useState, useCallback } from 'react';
import type { FormDataState, ImageResult } from '../types';
import { useApi } from '../contexts/ApiContext';
import { useTranslation } from '../contexts/TranslationContext';

export const useImageGeneration = () => {
  const api = useApi();
  const { translateShotLabel } = useTranslation();
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [images, setImages] = useState<ImageResult[]>([]);

  const generateImages = useCallback(async (
    formData: FormDataState,
    onSuccess?: (images: ImageResult[]) => void
  ) => {
    setIsLoading(true);
    setError(null);
    setImages([]);

    try {
      const shotLabels = {
        fullBody: translateShotLabel('fullBody'),
        medium: translateShotLabel('medium'),
        closeUp: translateShotLabel('closeUp'),
      };

      const generatedImages = await api.generateImages(formData, shotLabels);
      setImages(generatedImages);
      onSuccess?.(generatedImages);
    } catch (err) {
      const errorMessage = err instanceof Error ? err.message : 'ç”Ÿæˆå¤±æ•—';
      setError(errorMessage);
      throw err;
    } finally {
      setIsLoading(false);
    }
  }, [api, translateShotLabel]);

  return {
    generateImages,
    isLoading,
    error,
    images,
    setImages,
    setError,
  };
};
```

### ç¯„ä¾‹ 2ï¼šçµ±ä¸€ API å®¢æˆ¶ç«¯

```typescript
// services/apiClient.ts
import { GoogleGenAI } from '@google/genai';

class ApiClient {
  private client: GoogleGenAI | null = null;

  constructor(apiKey: string) {
    if (apiKey) {
      this.client = new GoogleGenAI({ apiKey });
    }
  }

  async generateImage(
    prompt: string,
    config: ImageConfig,
    signal?: AbortSignal
  ): Promise<ImageResult> {
    if (!this.client) {
      throw new Error('API Key is not available');
    }

    // çµ±ä¸€çš„ API å‘¼å«é‚è¼¯
    // åŒ…å«éŒ¯èª¤è™•ç†ã€é‡è©¦æ©Ÿåˆ¶ç­‰
  }

  async generateVideo(
    imageSrc: string,
    config: VideoConfig,
    signal?: AbortSignal
  ): Promise<VideoResult> {
    // çµ±ä¸€çš„å½±ç‰‡ç”Ÿæˆé‚è¼¯
  }
}

export const apiClient = new ApiClient(import.meta.env.VITE_API_KEY);
```

### ç¯„ä¾‹ 3ï¼šéŒ¯èª¤è™•ç†æ©Ÿåˆ¶

```typescript
// utils/errorHandler.ts
export enum ErrorType {
  NETWORK = 'NETWORK',
  API = 'API',
  VALIDATION = 'VALIDATION',
  AUTH = 'AUTH',
  UNKNOWN = 'UNKNOWN',
}

export interface AppError {
  type: ErrorType;
  message: string;
  originalError?: unknown;
  retryable: boolean;
}

export function handleError(error: unknown): AppError {
  if (error instanceof TypeError && error.message.includes('fetch')) {
    return {
      type: ErrorType.NETWORK,
      message: 'ç¶²è·¯é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ‚¨çš„ç¶²è·¯é€£ç·š',
      originalError: error,
      retryable: true,
    };
  }

  if (error instanceof Error) {
    if (error.message.includes('API')) {
      return {
        type: ErrorType.API,
        message: 'API å‘¼å«å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦',
        originalError: error,
        retryable: true,
      };
    }
  }

  return {
    type: ErrorType.UNKNOWN,
    message: 'ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦',
    originalError: error,
    retryable: false,
  };
}
```

---

## ğŸ“ çµè«–

é€™å€‹å°ˆæ¡ˆæ•´é«”æ¶æ§‹æ¸…æ™°ï¼ŒåŠŸèƒ½å®Œæ•´ï¼ŒæŠ€è¡“æ£§ç¾ä»£åŒ–ï¼Œä½†åœ¨ä»¥ä¸‹æ–¹é¢æœ‰æ”¹å–„ç©ºé–“ï¼š

1. **ç¨‹å¼ç¢¼çµ„ç¹”**ï¼šéœ€è¦é€²ä¸€æ­¥æ¨¡çµ„åŒ–ï¼Œå°‡æ¥­å‹™é‚è¼¯å¾ UI çµ„ä»¶ä¸­æŠ½é›¢
2. **éŒ¯èª¤è™•ç†**ï¼šéœ€è¦å»ºç«‹çµ±ä¸€çš„éŒ¯èª¤è™•ç†æ©Ÿåˆ¶ï¼Œæå‡ä½¿ç”¨è€…é«”é©—
3. **å‹åˆ¥å®‰å…¨**ï¼šéœ€è¦å®Œå–„å‹åˆ¥å®šç¾©ï¼Œæå‡ç¨‹å¼ç¢¼å“è³ª
4. **æ¸¬è©¦è¦†è“‹**ï¼šéœ€è¦åŠ å…¥æ¸¬è©¦ï¼Œæå‡ç¨‹å¼ç¢¼å¯é æ€§
5. **æ•ˆèƒ½å„ªåŒ–**ï¼šéœ€è¦å„ªåŒ–è¨˜æ†¶é«”ä½¿ç”¨èˆ‡è¼‰å…¥é€Ÿåº¦

å»ºè­°å„ªå…ˆè™•ç†é«˜å„ªå…ˆç´šé …ç›®ï¼Œé€æ­¥é‡æ§‹ä»¥æå‡ç¨‹å¼ç¢¼å“è³ªèˆ‡å¯ç¶­è­·æ€§ã€‚å°ˆæ¡ˆå·²ç¶“æœ‰è‰¯å¥½çš„åŸºç¤æ¶æ§‹ï¼Œé€éé€™äº›å„ªåŒ–å¯ä»¥é€²ä¸€æ­¥æå‡å°ˆæ¡ˆçš„å°ˆæ¥­åº¦èˆ‡ç©©å®šæ€§ã€‚






